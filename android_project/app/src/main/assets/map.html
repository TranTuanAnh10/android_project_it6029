<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Realtime Delivery Map (Shipper - Người nhận)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <style>
        /* CSS cho Map */
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            top: 0; left: 0;
            right: 0; bottom: 0;
        }

        /* CSS cho Loading Spinner (Góc trên bên phải) */
        #loader {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #FF3B30; /* Màu đỏ nổi bật */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 2px;
        }

        .hidden {
            display: none !important;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="loader" class="hidden"></div>

<script>
    // --- Khởi tạo các biến toàn cục ---
    var map = null;
    var shipperMarker = null;
    var receiverMarker = null;
    var routeLine = null;
    var locations = { receiver: null }; // Chỉ cần lưu Người nhận
    var currentStatus = "prepared";

    // --- Hàm hiển thị/ẩn Loading Spinner ---
    function showLoader() {
        document.getElementById('loader').classList.remove('hidden');
    }

    function hideLoader() {
        document.getElementById('loader').classList.add('hidden');
    }

    // --- Custom icons: GIỮ NGUYÊN TÀI NGUYÊN CŨ CỦA BẠN ---
    var shipIcon = L.icon({
        iconUrl: 'icons/Pin_ship.png',
        iconSize: [32, 36],
        iconAnchor: [16, 36],
    });

    var userIcon = L.icon({
        iconUrl: 'icons/Pin_user.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
    });

    // --- Hàm vẽ tuyến đường ---
    function drawRoute(lat1, lon1, lat2, lon2) {
        if (!map) return;

        // Kiểm tra khoảng cách tối thiểu để tránh lỗi gọi API (hai điểm trùng nhau)
        if (Math.abs(lat1 - lat2) < 0.00001 && Math.abs(lon1 - lon2) < 0.00001) {
            console.log("Cảnh báo: Điểm bắt đầu và kết thúc quá gần, không vẽ tuyến đường.");
            if (routeLine) map.removeLayer(routeLine);
            map.flyTo([lat2, lon2], map.getZoom() > 16 ? map.getZoom() : 16, { duration: 0.5 });
            return;
        }

        var url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson`;

        showLoader();

        fetch(url)
            .then(res => res.json())
            .then(data => {
                hideLoader();

                if (data.routes && data.routes.length > 0) {
                    var coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);

                    // Đảm bảo nối đến điểm đích
                    const last = coords[coords.length - 1];
                    if (last[0] !== lat2 || last[1] !== lon2) {
                        coords.push([lat2, lon2]);
                    }

                    // Xoá đường cũ
                    if (routeLine) map.removeLayer(routeLine);

                    // Vẽ mới màu đỏ
                    routeLine = L.polyline(coords, { color: '#FF3B30', weight: 5 }).addTo(map);

                    // Fit toàn tuyến
                    map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
                } else {
                    console.error("Không tìm thấy tuyến đường hợp lệ.");
                    if (routeLine) map.removeLayer(routeLine);
                }
            })
            .catch(err => {
                hideLoader();
                console.error("Lỗi khi lấy tuyến đường:", err);
                if (routeLine) map.removeLayer(routeLine);
            });
    }

    /**
     * HÀM CHÍNH: KHỞI TẠO MAP/MARKER LẦN ĐẦU HOẶC CẬP NHẬT VỊ TRÍ SHIPPER
     * Đã loại bỏ storeLat và storeLon. Chỉ nhận 5 tham số.
     * @param {number} shipperLat - Vĩ độ hiện tại của Shipper
     * @param {number} shipperLon - Kinh độ hiện tại của Shipper
     * @param {number} receiverLat - Vĩ độ của Người nhận (Tĩnh)
     * @param {number} receiverLon - Kinh độ của Người nhận (Tĩnh)
     * @param {string} status - Trạng thái giao hàng (e.g., 'prepared', 'shipping', 'finish')
     */
    function initOrUpdateMap(shipperLat, shipperLon, receiverLat, receiverLon, status) {
        // HÀM ĐÃ ĐƯỢC THAY ĐỔI: Bỏ hẳn storeLat và storeLon
        const receiverPos = [receiverLat, receiverLon];
        currentStatus = status;

        // Xác định xem có dữ liệu shipper hợp lệ hay không.
        const hasShipperData = (shipperLat !== 0 || shipperLon !== 0) && isFinite(shipperLat) && isFinite(shipperLon);

        // --- BƯỚC 1: KHỞI TẠO MAP VÀ MARKER TĨNH (CHỈ CHẠY LẦN ĐẦU) ---
        if (!map) {
            // Lưu tọa độ tĩnh của người nhận
            locations.receiver = receiverPos;

            // Vị trí trung tâm ban đầu: nếu có shipper thì trung tâm là shipper, ngược lại là người nhận
            const initialCenter = hasShipperData ? [shipperLat, shipperLon] : receiverPos;

            // 1. Khởi tạo map
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView(initialCenter, 15);

            // 2. Nền map
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                attribution: '&copy; CartoDB & OpenStreetMap'
            }).addTo(map);

            // 3. Tạo Marker Người nhận
            receiverMarker = L.marker(locations.receiver, { icon: userIcon, title: "Người nhận" }).addTo(map);

            // 4. Tạo Marker Shipper (Ẩn đi nếu chưa có data)
            shipperMarker = L.marker([0, 0], {
                icon: shipIcon,
                title: "Shipper",
                opacity: hasShipperData ? 1 : 0
            }).addTo(map);

            // Xóa đường nếu trạng thái ban đầu là finish
            if (status === "finish") {
                if (routeLine) map.removeLayer(routeLine);
                hideLoader();
                shipperMarker.setOpacity(0);
            }
        }

        // --- BƯỚC 2: CẬP NHẬT VỊ TRÍ VÀ TUYẾN ĐƯỜNG (CHẠY MỌI LÚC) ---

        if (status === "finish") {
            // Trạng thái Finish: Ẩn Shipper và xóa đường
            if (routeLine) map.removeLayer(routeLine);
            hideLoader();
            shipperMarker.setOpacity(0);
            map.flyTo(locations.receiver, 16, { duration: 0.8 });
            return;
        }

        if (hasShipperData) {
            // --- KỊCH BẢN A: CÓ DATA SHIPPER ---
            const shipperPos = [shipperLat, shipperLon];

            // 1. Cập nhật vị trí và hiển thị Shipper
            shipperMarker.setLatLng(shipperPos);
            shipperMarker.setOpacity(1);

            // 2. VẼ ĐƯỜNG TỪ SHIPPER ĐẾN NGƯỜI NHẬN
            const isAtReceiver = Math.abs(shipperLat - locations.receiver[0]) < 0.00001 &&
                                 Math.abs(shipperLon - locations.receiver[1]) < 0.00001;

            if (!isAtReceiver) {
                // Vẽ tuyến đường Shipper -> Người nhận
                drawRoute(shipperLat, shipperLon, locations.receiver[0], locations.receiver[1]);
            } else {
                // Shipper đã đến Người nhận
                if (routeLine) map.removeLayer(routeLine);
                hideLoader();
                map.flyTo(locations.receiver, 16, { duration: 0.5 });
            }

            // 3. Zoom mượt đến shipper
            map.flyTo(shipperPos, map.getZoom() > 15 ? map.getZoom() : 15, { duration: 0.5 });

        } else {
            // --- KỊCH BẢN B: KHÔNG CÓ DATA SHIPPER (0, 0) ---

            // 1. Ẩn Shipper Marker
            if (shipperMarker) {
                shipperMarker.setOpacity(0);
            }

            // 2. Xóa tuyến đường (vì không thể vẽ đường từ Shipper nếu không có tọa độ)
            if (routeLine) map.removeLayer(routeLine);
            hideLoader();

            // 3. Zoom vào người nhận
            map.flyTo(locations.receiver, 15, { duration: 0.5 });
        }
    }

    window.initOrUpdateMap = initOrUpdateMap;
</script>
</body>
</html>