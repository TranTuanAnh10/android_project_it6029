<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Realtime Delivery Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            top: 0; left: 0;
            right: 0; bottom: 0;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    // --- Kh·ªüi t·∫°o map ---
    var map = L.map('map', {
        zoomControl: false,
        attributionControl: false
    }).setView([21.0285, 105.8542], 15);

    // --- N·ªÅn map ---
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
        attribution: '&copy; CartoDB & OpenStreetMap'
    }).addTo(map);

    // --- Custom icons ---
    var shipIcon = L.icon({
        iconUrl: 'icons/Pin_ship.png',
        iconSize: [32, 36],
        iconAnchor: [16, 36],
    });

    var storeIcon = L.icon({
        iconUrl: 'icons/Pin_shop.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
    });

    var userIcon = L.icon({
        iconUrl: 'icons/Pin_user.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
    });

    // --- C√°c to·∫° ƒë·ªô m·∫´u ---
    var locations = {
        shipper: [21.0285, 105.8542],
        store: [21.031, 105.852],
        receiver: [21.035, 105.85]
    };

    // --- Marker ---
    var shipperMarker = L.marker(locations.shipper, { icon: shipIcon, title: "Shipper" }).addTo(map);
    var storeMarker = L.marker(locations.store, { icon: storeIcon, title: "C·ª≠a h√†ng" }).addTo(map);
    var receiverMarker = L.marker(locations.receiver, { icon: userIcon, title: "Ng∆∞·ªùi nh·∫≠n" }).addTo(map);

    var routeLine = null; // ƒë∆∞·ªùng ƒëi hi·ªán t·∫°i
    var currentStatus = "prepared";

    // --- H√†m v·∫Ω tuy·∫øn ƒë∆∞·ªùng ---
    function drawRoute(lat1, lon1, lat2, lon2) {
        var url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson`;

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    var coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);

                    // ƒê·∫£m b·∫£o n·ªëi ƒë·∫øn ƒëi·ªÉm ƒë√≠ch
                    const last = coords[coords.length - 1];
                    if (last[0] !== lat2 || last[1] !== lon2) {
                        coords.push([lat2, lon2]);
                    }

                    // Xo√° ƒë∆∞·ªùng c≈©
                    if (routeLine) map.removeLayer(routeLine);

                    // V·∫Ω m·ªõi m√†u ƒë·ªè
                    routeLine = L.polyline(coords, { color: '#FF3B30', weight: 5 }).addTo(map);

                    // Fit to√†n tuy·∫øn
                    map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
                }
            })
            .catch(err => console.error("L·ªói khi l·∫•y tuy·∫øn ƒë∆∞·ªùng:", err));
    }

    // --- C·∫≠p nh·∫≠t realtime t·ª´ Android ---
    function updateLocation(lat, lon, status) {
        shipperMarker.setLatLng([lat, lon]);
        currentStatus = status;

        switch (status) {
            case "prepared":
            case "pickingUp":
                // üöö T·ª´ shipper ƒë·∫øn c·ª≠a h√†ng
                drawRoute(lat, lon, locations.store[0], locations.store[1]);
                break;
            case "delivering":
                // üöö T·ª´ c·ª≠a h√†ng ƒë·∫øn ng∆∞·ªùi nh·∫≠n
                drawRoute(lat, lon, locations.receiver[0], locations.receiver[1]);
                break;
            case "finish":
                // ‚úÖ Giao xong ‚Äî ch·ªâ zoom v√†o ng∆∞·ªùi nh·∫≠n
                if (routeLine) map.removeLayer(routeLine);
                map.flyTo(locations.receiver, 16, { duration: 0.8 });
                break;
        }

        // Zoom m∆∞·ª£t ƒë·∫øn shipper m·ªói khi c·∫≠p nh·∫≠t
        if (status !== "finish") {
            map.flyTo([lat, lon], 15, { duration: 0.5 });
        }
    }

    window.updateLocation = updateLocation;

    // --- V·∫Ω tuy·∫øn ban ƒë·∫ßu ---
    drawRoute(locations.shipper[0], locations.shipper[1], locations.store[0], locations.store[1]);
</script>
</body>
</html>
